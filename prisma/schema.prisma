// Prisma Schema for Media Storage Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum Definitions
enum UserRole {
  SYSTEM
  ADMIN
  STAFF
  EDITOR
  VIEWER
}

enum VideoVisibility {
  PUBLIC
  PRIVATE
  DOMAIN_RESTRICTED
}

enum VideoStatus {
  PROCESSING
  READY
  FAILED
}

// User Model
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String   // Hashed password
  role      UserRole @default(VIEWER)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  videos    Video[]
  apiTokens ApiToken[]

  @@map("users")
}

// Category Model
model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  videos Video[]

  @@map("categories")
}

model Studio {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("studios")
}

// Video Model
model Video {
  id           String          @id @default(cuid())
  title        String
  description  String?
  movieCode    String?         @map("movie_code")
  studio       String?         @map("studio")
  releaseDate  DateTime?       @map("release_date")
  tags         String[]        @default([])
  videoUrl     String          @map("video_url") // R2 URL
  thumbnailUrl String?         @map("thumbnail_url") // R2 URL
  duration     Int?            // in seconds
  fileSize     BigInt?         @map("file_size") // in bytes
  mimeType     String?         @map("mime_type")
  storageBucket String         @default("media") @map("storage_bucket")
  visibility   VideoVisibility @default(PUBLIC)
  status       VideoStatus     @default(PROCESSING)
  transcodeProgress Int?       @map("transcode_progress")
  views        Int             @default(0)
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  // Foreign Keys
  createdById String @map("created_by_id")

  // Relations
  categories    Category[]
  createdBy     User            @relation(fields: [createdById], references: [id], onDelete: Cascade)
  allowedDomains VideoAllowedDomain[]
  actors        Actor[]
  viewsLog      VideoView[]

  @@index([createdById])
  @@index([status])
  @@index([visibility])
  @@index([storageBucket])
  @@map("videos")
}

model VideoView {
  id         String   @id @default(cuid())
  videoId    String   @map("video_id")
  viewerKey  String   @map("viewer_key")
  viewBucket String   @map("view_bucket")
  createdAt  DateTime @default(now()) @map("created_at")

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, viewerKey, viewBucket])
  @@index([videoId, createdAt])
  @@map("video_views")
}

// Actor Model
model Actor {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  videos Video[]

  @@map("actors")
}

// Allowed Domains for Video Access
model AllowedDomain {
  id        String   @id @default(cuid())
  domain    String   @unique
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  videos VideoAllowedDomain[]

  @@map("allowed_domains")
}

// Many-to-Many relation between Video and AllowedDomain
model VideoAllowedDomain {
  id       String @id @default(cuid())
  videoId  String @map("video_id")
  domainId String @map("domain_id")

  video  Video         @relation(fields: [videoId], references: [id], onDelete: Cascade)
  domain AllowedDomain @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@unique([videoId, domainId])
  @@index([videoId])
  @@index([domainId])
  @@map("video_allowed_domains")
}

// API Tokens for admin access
model ApiToken {
  id          String   @id @default(cuid())
  name        String
  tokenHash   String   @unique @map("token_hash")
  tokenLast4  String   @map("token_last4")
  expiresAt   DateTime? @map("expires_at")
  lastUsedAt  DateTime? @map("last_used_at")
  revokedAt   DateTime? @map("revoked_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  createdById String @map("created_by_id")

  createdBy User @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@index([expiresAt])
  @@map("api_tokens")
}
